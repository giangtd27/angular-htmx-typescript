<div class="users-container" id="users-container">
  <div class="users-header">
    <h1>User Management</h1>
    @if (canEdit()) {
      <button 
        class="btn btn-primary" 
        (click)="onCreate()">
        <span>+ Add User</span>
      </button>
    }
  </div>

  @if (loading()) {
    <div class="loading">Loading users...</div>
  }

  <!-- HTMX will load and swap content here -->
  <div 
    id="users-list"
    [attr.hx-get]="'/api/users/list'"
    [attr.hx-trigger]="'load, refreshUsers from:body'"
    [attr.hx-swap]="'innerHTML'"
    [attr.hx-indicator]="'.loading'">
    <!-- Initial load via Angular -->
    @if (!loading()) {
      <div class="users-table-container">
        <table class="users-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Email</th>
              <th>Role</th>
              <th>Created At</th>
              @if (canEdit()) {
                <th>Actions</th>
              }
            </tr>
          </thead>
          <tbody>
            @for (user of users(); track user.id) {
              <tr id="user-row-{{ user.id }}">
                <td>{{ user.id }}</td>
                <td>{{ user.name }}</td>
                <td>{{ user.email }}</td>
                <td>
                  <span class="role-badge" [attr.data-role]="user.role">
                    {{ getRoleLabel(user.role) }}
                  </span>
                </td>
                <td>{{ formatDate(user.createdAt) }}</td>
                @if (canEdit()) {
                  <td class="actions">
                    <button 
                      class="btn-icon" 
                      (click)="onEdit(user)"
                      title="Edit">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                        <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" fill="currentColor"/>
                      </svg>
                    </button>
                    @if (canChangePassword(user)) {
                      <button 
                        class="btn-icon" 
                        (click)="onChangePassword(user)"
                        title="Change Password">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                          <path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zM12 17c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z" fill="currentColor"/>
                        </svg>
                      </button>
                    }
                    @if (canDelete()) {
                      <button 
                        class="btn-icon btn-icon-danger" 
                        (click)="onDelete(user)"
                        title="Delete">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                          <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" fill="currentColor"/>
                        </svg>
                      </button>
                    }
                  </td>
                }
              </tr>
            } @empty {
              <tr>
                <td colspan="6" class="empty-state">No users found</td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    }
  </div>
</div>

<!-- Create User Dialog -->
@if (showCreateDialog()) {
  <app-user-form
    [open]="showCreateDialog()"
    (saved)="onUserCreated()"
    (cancelled)="cancelCreate()"
    (closed)="cancelCreate()">
  </app-user-form>
}

<!-- Update User Dialog -->
@if (showUpdateDialog() && selectedUser()) {
  <app-user-form
    [user]="selectedUser()!"
    [open]="showUpdateDialog()"
    (saved)="onUserUpdated()"
    (cancelled)="cancelUpdate()"
    (closed)="cancelUpdate()">
  </app-user-form>
}

<!-- Delete Confirmation Dialog -->
@if (showDeleteDialog() && userToDelete()) {
  <app-confirmation-dialog
    title="Delete User"
    [message]="'Are you sure you want to delete user ' + (userToDelete()?.name || '') + '? This action cannot be undone.'"
    confirmText="Delete"
    cancelText="Cancel"
    [type]="DialogType.DELETE"
    [open]="showDeleteDialog()"
    (confirmed)="confirmDelete()"
    (cancelled)="cancelDelete()"
    (closed)="cancelDelete()">
  </app-confirmation-dialog>
}

<!-- Change Password Dialog -->
@if (showPasswordDialog() && userToChangePassword()) {
  <app-update-password
    [open]="showPasswordDialog()"
    [targetUser]="userToChangePassword()!"
    (saved)="onPasswordUpdated()"
    (cancelled)="cancelPasswordChange()"
    (closed)="cancelPasswordChange()">
  </app-update-password>
}

<!-- Dialog container for HTMX-loaded forms (if needed) -->
<div id="dialog-container"></div>
